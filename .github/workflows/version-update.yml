name: Version Update + Release (main)

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write

concurrency:
  group: release-main
  cancel-in-progress: false

jobs:
  release:
    if: >
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'main' &&
      github.event.pull_request.head.ref == 'update'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main (latest)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Pull latest main
        run: |
          git fetch origin main --prune
          git reset --hard origin/main

      - name: Read version from module.json
        id: ver
        run: |
          node - <<'NODE'
          const fs = require("fs");
          const j = JSON.parse(fs.readFileSync("module.json","utf8"));
          const v = (j.version || "").trim();
          if (!/^\d+\.\d+\.\d+$/.test(v)) {
            throw new Error(`module.json version must be x.y.z (no leading 'v'), got: "${v}"`);
          }
          fs.writeFileSync(process.env.GITHUB_OUTPUT, `version=${v}\ntag=v${v}\n`, { flag: "a" });
          NODE

      - name: Check if tag already exists
        id: tagcheck
        run: |
          if git rev-parse "${{ steps.ver.outputs.tag }}" >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create tag (vX.Y.Z) and push
        if: steps.tagcheck.outputs.exists == 'false'
        run: |
          git tag "${{ steps.ver.outputs.tag }}"
          git push origin "${{ steps.ver.outputs.tag }}"


      - name: Build ZIP (stable asset name)
        run: |
          rm -f module-latest.zip
          zip -r module-latest.zip . \
            -x ".git/*" \
            -x ".github/*" \
            -x "releases/*" \
            -x "node_modules/*" \
            -x "*.zip"

      - name: Create GitHub Release + upload asset
        if: steps.tagcheck.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.tag }}
          name: ${{ steps.ver.outputs.tag }}
          generate_release_notes: true
          files: |
            module-latest.zip

      - name: Sync update branch to main (fast reset)
        run: |
          git push origin HEAD:update --force
